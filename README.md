# README

- [README](#readme)
  - [参考資料](#参考資料)
  - [開発環境](#開発環境)
    - [サーバ環境](#サーバ環境)
    - [クライアント環境](#クライアント環境)
  - [環境構築](#環境構築)
    - [ネットワーク設定](#ネットワーク設定)
    - [ファイアウォール設定](#ファイアウォール設定)
      - [現在の状態を確認](#現在の状態を確認)
      - [ポートを開放](#ポートを開放)
    - [オレオレ証明書を作成](#オレオレ証明書を作成)
    - [ルータに接続したデバイス間の通信](#ルータに接続したデバイス間の通信)
    - [クライアントをサーバと同じネットワークに接続する](#クライアントをサーバと同じネットワークに接続する)
    - [python環境構築](#python環境構築)
      - [venvインストール](#venvインストール)
      - [仮想環境作成](#仮想環境作成)
      - [仮想環境起動](#仮想環境起動)
      - [仮想環境終了](#仮想環境終了)
      - [仮想環境に依存パッケージをインストール](#仮想環境に依存パッケージをインストール)
  - [実行操作](#実行操作)
    - [サーバ起動](#サーバ起動)
    - [クライアント操作](#クライアント操作)

## 参考資料

- [スマフォカメラにブラウザからアクセス - Qiita](https://qiita.com/tkyko13/items/1871d906736ac88a1f35)

実装の参考

- [[HTML5] カメラをJSで操作し写真を撮影する](https://blog.katsubemakito.net/html5/camera1)
- [[HTML5] Canvasを画像に変換しサーバへ送信する](https://blog.katsubemakito.net/html5/canvas-sendserver)

## 開発環境

### サーバ環境

- モデル: FMVS90TRD2
- OS: elementary OS 5.1.7 Hera
- Python: Python 3.6.9 (OSにプリインストールされていたもの)

### クライアント環境

- モデル：ASUS_Z017DA
- ビルド番号：OPR1.170623.026.JP_Phone-15.0410.1807.75
- OS: Android 8.0.0
- ブラウザ：Chrome 92.0.4515.131

## 環境構築

### ネットワーク設定

サーバのIPアドレスは`192.168.10.103`であること。

```bash
$ ip addr show wlp2s0 | grep -w  inet
inet 192.168.10.103/24 brd 192.168.10.255 scope global dynamic noprefixroute wlp2s0
```

### ファイアウォール設定

ファイアウォールでクライアントからサーバへのパケットをブロックされるとwebサーバへアクセスできないので、ポートを開放する。
ここでは8081番ポートを開放する。

#### 現在の状態を確認

```bash
$ sudo ufw status
状態: アクティブ
```

#### ポートを開放

```bash
sudo ufw allow 8081
sudo ufw reload

$ sudo ufw status
状態: アクティブ

To                         Action      From
--                         ------      ----
8081                       ALLOW       Anywhere
8081 (v6)                  ALLOW       Anywhere (v6)
```

### オレオレ証明書を作成

httpsでのssl通信を行うには証明書が必要だが、本プロジェクトで使用するwebサーバは外部に公開するわけではないので、いわゆるオレオレ証明書を作成する。

```bash
# 3650日間有効な証明書を作成
# 有効期間は`-days`オプションで指定
openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout key.pem -out cert.pem
# 証明書を`keys`ディレクトリに移動
mv key.pem cert.pem keys/
```

この方法で作成した証明書を使用してhttpsサーバを立てると、ブラウザからアクセスしたときに警告が出る。
これは無視してよい。

### ルータに接続したデバイス間の通信

ルータの設定によっては，接続しているデバイス間で通信できない。
ルータの設定を確認すること。

### クライアントをサーバと同じネットワークに接続する

ここでは簡単のためにクライアントをWi-Fiでサーバへ接続するものとする。

**サーバからクライアントにpingが通ったとしても，同じネットワークに接続していないとwebアプリケーションへアクセスできない。**
クライアントのipアドレスを見て，サーバと同じネットワークに接続していることを必ず確認すること。
android端末のipアドレスは，今回使用するモデルの場合は
**設定アプリ -> 無線とネットワーク -> Wi-Fi -> 右上のハンバーガーボタン -> Wi-Fi詳細**
から見られる。

### python環境構築

pythonの仮想環境管理にはvenvを使用する。

#### venvインストール

`sudo apt install python3-venv`

#### 仮想環境作成

```bash
cd [プロジェクトルートディレクトリ]
# ".venv"という名前で仮想環境を作成する
python3 -m venv .venv
```

#### 仮想環境起動

`source .venv/bin/activate`

#### 仮想環境終了

`deactivate`

#### 仮想環境に依存パッケージをインストール

```bash
# pipのバージョンが古いとパッケージのインストールでコケるので、
# 最新のバージョンに更新する。
pip install -U pip
pip install opencv-python flask flask-cors
```

## 実行操作

### サーバ起動

`python run.py`

### クライアント操作

ブラウザで`https://192.168.10.103:8081/`にアクセスする。
